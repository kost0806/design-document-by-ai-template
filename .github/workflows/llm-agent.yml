name: LLM Agent Workflow

on:
  issues:
    types: [labeled]

concurrency:
  group: llm-agent-${{ github.repository }}
  cancel-in-progress: false

jobs:
  run-claude:
    if: |
      startsWith(github.event.label.name, 'claude:') &&
      github.event.issue.user.login == github.repository_owner
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Run Claude Code CLI
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          LABEL_NAME: ${{ github.event.label.name }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Extract model from label (claude:model-name -> model-name)
          MODEL=$(echo "$LABEL_NAME" | cut -d':' -f2)
          echo "Using Claude model: $MODEL"

          # Validate issue body length (max 50,000 characters to prevent abuse)
          BODY_LENGTH=$(echo "$ISSUE_BODY" | wc -c)
          if [ "$BODY_LENGTH" -gt 50000 ]; then
            echo "Error: Issue body too long ($BODY_LENGTH characters). Maximum 50,000 characters allowed." > result.txt
            echo "RESULT<<EOF" >> $GITHUB_OUTPUT
            cat result.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Run Claude Code CLI with the prompt (using -p for print mode and stdin)
          echo "Running Claude Code CLI..." >&2
          echo "$ISSUE_BODY" | claude -p --model "$MODEL" > result.txt 2>&1 || echo "Error: Failed to run Claude Code with model '$MODEL'" > result.txt

          # Read result
          RESULT=$(cat result.txt)
          echo "RESULT<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Create PR if files changed
        id: create_pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # Check if there are file changes using git
          if [ -z "$(git status --porcelain)" ]; then
            echo "No file changes detected"
            echo "PR_CREATED=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Show changed files
          echo "Changed files:"
          git status --short

          # Create branch name
          BRANCH_NAME="claude-fix-issue-${ISSUE_NUMBER}-$(date +%s)"
          echo "Creating branch: $BRANCH_NAME"

          # Create and switch to new branch
          git checkout -b "$BRANCH_NAME"

          # Add all changed files
          git add -A

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "PR_CREATED=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Commit changes
          git commit -m "ü§ñ Fix issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

          Changes made by Claude AI via GitHub Actions.

          Issue: #${ISSUE_NUMBER}"

          # Push branch
          git push origin "$BRANCH_NAME"

          # Create PR using GitHub CLI
          PR_URL=$(gh pr create \
            --title "ü§ñ Fix issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}" \
            --body "This PR was automatically generated by Claude AI to address issue #${ISSUE_NUMBER}.

          ## ü§ñ AI-Generated Changes

          Claude analyzed the issue and made the following changes:

          $(cat result.txt | head -n 50)

          ## üìù Related Issue

          Closes #${ISSUE_NUMBER}

          ---
          *This PR was automatically created by the LLM Agent workflow.*" \
            --base main \
            --head "$BRANCH_NAME")

          echo "PR created: $PR_URL"
          echo "PR_URL=$PR_URL" >> $GITHUB_OUTPUT
          echo "PR_CREATED=true" >> $GITHUB_OUTPUT
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Comment result on issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const result = `${{ steps.claude.outputs.RESULT }}`;
            const truncated = result.length > 60000 ? result.substring(0, 60000) + '\n\n... (truncated)' : result;
            const prCreated = '${{ steps.create_pr.outputs.PR_CREATED }}' === 'true';
            const prUrl = '${{ steps.create_pr.outputs.PR_URL }}';

            let body = `## ü§ñ Claude Code Result\n\n**Prompt:**\n> ${context.payload.issue.body.substring(0, 500)}${context.payload.issue.body.length > 500 ? '...' : ''}\n\n**Response:**\n\`\`\`\n${truncated}\n\`\`\``;

            if (prCreated) {
              body += `\n\n---\n\n## üîÄ Pull Request Created\n\nClaude has made changes to the repository and created a pull request:\n\n‚û°Ô∏è ${prUrl}\n\nPlease review the changes and merge if appropriate.`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  run-gemini:
    if: |
      startsWith(github.event.label.name, 'gemini:') &&
      github.event.issue.user.login == github.repository_owner
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Gemini CLI
        run: |
          npm install -g @google/gemini-cli

      - name: Run Gemini CLI
        id: gemini
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          LABEL_NAME: ${{ github.event.label.name }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Extract model from label (gemini:model-name -> model-name)
          MODEL=$(echo "$LABEL_NAME" | cut -d':' -f2)
          echo "Using Gemini model: $MODEL"

          # Validate issue body length (max 50,000 characters to prevent abuse)
          BODY_LENGTH=$(echo "$ISSUE_BODY" | wc -c)
          if [ "$BODY_LENGTH" -gt 50000 ]; then
            echo "Error: Issue body too long ($BODY_LENGTH characters). Maximum 50,000 characters allowed." > result.txt
            echo "RESULT<<EOF" >> $GITHUB_OUTPUT
            cat result.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Run Gemini CLI with the prompt (using stdin)
          echo "Running Gemini CLI..." >&2
          echo "$ISSUE_BODY" | gemini -m "$MODEL" > result.txt 2>&1 || echo "Error: Failed to run Gemini CLI with model '$MODEL'" > result.txt

          # Read result
          RESULT=$(cat result.txt)
          echo "RESULT<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Create PR if files changed
        id: create_pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # Check if there are file changes using git
          if [ -z "$(git status --porcelain)" ]; then
            echo "No file changes detected"
            echo "PR_CREATED=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Show changed files
          echo "Changed files:"
          git status --short

          # Create branch name
          BRANCH_NAME="gemini-fix-issue-${ISSUE_NUMBER}-$(date +%s)"
          echo "Creating branch: $BRANCH_NAME"

          # Create and switch to new branch
          git checkout -b "$BRANCH_NAME"

          # Add all changed files
          git add -A

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "PR_CREATED=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Commit changes
          git commit -m "ü§ñ Fix issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

          Changes made by Gemini AI via GitHub Actions.

          Issue: #${ISSUE_NUMBER}"

          # Push branch
          git push origin "$BRANCH_NAME"

          # Create PR using GitHub CLI
          PR_URL=$(gh pr create \
            --title "ü§ñ Fix issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}" \
            --body "This PR was automatically generated by Gemini AI to address issue #${ISSUE_NUMBER}.

          ## ü§ñ AI-Generated Changes

          Gemini analyzed the issue and made the following changes:

          $(cat result.txt | head -n 50)

          ## üìù Related Issue

          Closes #${ISSUE_NUMBER}

          ---
          *This PR was automatically created by the LLM Agent workflow.*" \
            --base main \
            --head "$BRANCH_NAME")

          echo "PR created: $PR_URL"
          echo "PR_URL=$PR_URL" >> $GITHUB_OUTPUT
          echo "PR_CREATED=true" >> $GITHUB_OUTPUT
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Comment result on issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const result = `${{ steps.gemini.outputs.RESULT }}`;
            const truncated = result.length > 60000 ? result.substring(0, 60000) + '\n\n... (truncated)' : result;
            const prCreated = '${{ steps.create_pr.outputs.PR_CREATED }}' === 'true';
            const prUrl = '${{ steps.create_pr.outputs.PR_URL }}';

            let body = `## ü§ñ Gemini Result\n\n**Prompt:**\n> ${context.payload.issue.body.substring(0, 500)}${context.payload.issue.body.length > 500 ? '...' : ''}\n\n**Response:**\n\`\`\`\n${truncated}\n\`\`\``;

            if (prCreated) {
              body += `\n\n---\n\n## üîÄ Pull Request Created\n\nGemini has made changes to the repository and created a pull request:\n\n‚û°Ô∏è ${prUrl}\n\nPlease review the changes and merge if appropriate.`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
